# Azure Artifacts - slideless delivery

## Service Description

Azure Artifacts allows you to organize your packages into a single source, known as a feed, that can be shared across your entire organization. This allows your team to access packages from a single location including their favorite OSS packages from public upstream sources.

## Agenda

- Feeds
- Views
- Upstream sources
- Using Azure Artifacts feeds in Azure DevOps pipelines
- Publishing a package to an Azure Artifacts feed
- Best Practices  

## Prerequisites

- The ability to join a Microsoft Teams call and screen share.
- Access to an Azure DevOps subscription with the ability to create an Azure Artifacts feed, create an Azure DevOps build pipeline, and create an Azure DevOps release pipeline.
- The NuGet Package Explorer. You can download it from the Microsoft Store here https://www.microsoft.com/en-us/p/nuget-package-explorer/9wzdncrdmdm3?activetab=pivot:overviewtab. This is desktop tool that can be used to create NuGet packages and metadata files. If you plan to use the provided C# class library sample project you don't need to demonstrate how to use the NuGet Package Explorer.
- A C# class library sample project that can be used to create a simple NuGet package. This can be a .Net Framework or .Net Core application. A sample C# solution can be obtained from here https://github.com/nimccoll/nugetexamples that includes an appropriate .nuspec metadata file. The sample solution should be placed in a Git source control repository in GitHub or Azure Repos so it can be leveraged by Azure DevOps pipelines during the walkthroughs. 

    This will be a demonstration-led session. The customer should have access to an Azure DevOps subscription so they can follow along and build out their own POC during the delivery.  

- The C# class library sample project will be used as the source for a NuGet package that will be published to an Azure Artifacts feed.
- You will demonstrate how the class library project can be built and packaged using an Azure DevOps build pipeline.
- You will demonstrate how the package generated by the build pipeline can be published to an Azure Artifacts feed.  

## Feeds  

Packages are stored in feeds. Feeds are an organizational construct that allow you to group packages and control who has access to them.

- Explain how feeds are package type independent and you can store any package type in them.
    - Nuget
    - npm
    - Maven
    - Python
    - Universal
- Explain the difference between project-scoped feeds and organization-scoped feeds (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/feeds?view=azure-devops#project-scoped-feeds-vs-organization-scoped-feeds)
- Explain how you can create public feeds that can be shared with anyone on the Internet (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/feeds?view=azure-devops#public-feeds)

## Views

Views allow you to share a subset of the NuGet, npm, Maven, and Python package versions available in your feed with your consumers. Views allow you to create a promotion model for your packages whereby packages that have been tested, validated, and deployed are made available to your full audience while packages under development or packages that haven't been fully validated are shared with select members of your audience.

- Explain the three views provided for each Azure Artifacts feed (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/views?view=azure-devops#views-and-upstream-sources)
    - @local
    - @prerelease
    - @release
- Explain the concept of immutability of package versions and how views can be leveraged to create a promotion model to address package versioning issues (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/views?view=azure-devops#using-views-to-release-packages)
- Explain how views can be used as a mechanism to release packages (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/views?view=azure-devops#using-views-to-release-packages)

## Upstreams

Upstream sources allow you to create a single feed that includes the packages you publish to it and packages from "remote feeds" such as NuGet.org, npmjs.com, Maven Central, and PyPi as well as other Azure Artifacts feeds that you have access to.

- Explain how a copy of the packages from upstream sources that are installed by users of the feed are saved in the feed. The feed becomes a cache for commonly used remote packages providing improved performance (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/upstream-sources?view=azure-devops#offline-upstreams)
- Explain the importance of using a feed as the single source for your packages if you choose to include upstream sources in the feed.
- Review the benefits of upstream sources (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/upstream-sources?view=azure-devops#benefits-of-upstream-sources)
- Review best practices for feed consumers (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/upstream-sources?view=azure-devops#best-practices-feed-consumers)
- Review best practices for feed owners and package produces (https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/upstream-sources?view=azure-devops#best-practices-feed-ownerspackage-producers)

## Walkthrough - Create an Azure Artifacts Feed

- Open your Azure DevOps subscription and select a project
- Select Artifacts from the left-hand navigation menu
- Select +Create Feed from the menu
- Enter a name for the feed
- Choose who the feed will be visible to
  - This is a good time to review the options available with the customer
- Leave the Upstream sources checkbox checked to include the common public remote feeds (NuGet.org, npmjs.com, etc.)
- A detailed visual walkthrough can be found here https://docs.microsoft.com/en-us/azure/devops/artifacts/get-started-nuget?view=azure-devops#create-a-feed

## Walkthrough - Publish a Package to an Azure Artifacts Feed

- Follow the steps here https://docs.microsoft.com/en-us/azure/devops/artifacts/get-started-nuget?view=azure-devops#publish-a-package to publish the Microsoft sample HelloWorld NuGet package to your feed

## Walkthrough - Add Your Feed as a Package Source in Visual Studio

- Follow the steps here https://docs.microsoft.com/en-us/azure/devops/artifacts/get-started-nuget?view=azure-devops#publish-a-package to add your Azure Artifacts feed as a package source in Microsoft Visual Studio

## Walkthrough - Use Your Feed in an Azure Build Pipeline

-  Create a new build pipeline using the classic editor so the user can easily visualize the steps in the process
- Select the repository containing the sample C# class library solution
- Since we are building a simple class library project you can select the .Net Desktop template
- In the process editor select the NuGet Restore step
- On the NuGet Restore dialog select "Feed(s) I select here" under "Feeds to use" and choose your Azure Artifacts feed from the drop-down list box
- A detailed visual walkthrough can be found here https://docs.microsoft.com/en-us/azure/devops/pipelines/packages/nuget-restore?view=azure-devops

## Walkthrough - Create a Feed with Additional Views

- Follow the steps above under [Walkthrough - Create an Azure Artifacts Feed](#walkthrough---create-an-azure-artifacts-feed)
- Click the "gear" icon and select Feed settings from the drop-down menu
- Click Views from the menu
- Select the Prerelease view and click Edit from the menu
- Make the prerelease view visible to one or more people who you would like to be able to view prerelease packages and click Ok
- Select the Release view and click Edit from the menu
- Make the view visible to everyone in your organization
- Check the "Make this the default view" checkbox and click Ok
- Select the Local view and click Edit
- Make the local view visible to only people who will be creating packages and click Ok

## Walkthrough - Build a package using Azure Pipelines

- Create a new build pipeline using the classic editor so the user can easily visualize the steps in the process
- Select the repository containing the sample C# class library solution
- Since we are building a simple class library project you can select the .Net Desktop template
- Remove the VsTest - testAssemblies step from Agent job 1
- Add a NuGet step after the Build solution step
- On the NuGet dialog select "pack" from the Command drop-down list box
- Use the ellipsis next to the "Path to csproj or nuspec file(s) to pack" text box to navigate to the sample .nuspec file included in the solution
- Save the pipeline and give it an appropriate name
- Execute the build and examine the generated artifacts to show the created .nupkg file

## Walkthrough - Publish and Promote a package using Azure Pipelines

- Create a new release pipeline using the classic editor so the user can easily visualize the steps in the process
- Choose the empty job template
- Change the stage name to Local
- Click Add an artifact
- Select the build pipeline you created in the earlier walkthrough from the Source drop down list box
- Click Local to open up the process editor
- Add a NuGet step to the Agent job
- On the NuGet dialog select "push" from the Command drop-down list box
- Use the ellipsis next to the "Path to NuGet package(s) to publish" text box to navigate to the .nupkg file that was generated by the build
- For the "Target feed location" choose the "This organization/collection" radio button
- Select your Azure Artifacts feed from the "Target feed" drop-down list box
- Save the pipeline and give it an appropriate name  

At this point if you are only using the default Local view in your feed you are done. You can queue a release to publish your package to your feed and it will be available in the Local view.  

If you want to leverage the Prerelease and Release views to employ a promotion model for your packages continue with the steps below.  

- Return to the pipeline editor and add two additional stages to the pipeline
  - Add a stage named Prerelease to promote your package to the Prerelease view
  - Add a staged name Release to promote your package to the Release view
- Click the Prerelease stage to open the process editor
- Add a task to the Agent job and select Marketplace from the menu
- Search for a task named "Promote package to Release View" and click the "Get it free" button (note: you must have appropriate permissions to add an extension to your Azure DevOps subscription)
- On the Promote package to Release View dialog select your feed name, package name, enter the package version you wish to promote, and the view you wish to promote it to, in this case Prerelease
- Save the pipeline
- Return to the pipeline editor and click the Release stage to open the process editor
- Add a Promote package to Release View task to the agent job
- On the Promote package to Release View dialog select your feed name, package name, enter the package version you wish to promote, and the view you wish to promote it to, in this case Release
- Save the pipeline
- Return to the pipeline editor
- At this point you should add prerelease conditions such as approvals to the Prerelease and Release stages to allow you to control when packages are promoted to each view
- Queue a release to push the package to the Local view
- Once the push to the Local view is complete you can return to the pipeline and trigger the Prerelease stage to promote the package to the Prerelease view
- Repeat the above step for the Release stage to promote the package to the Release view where it will be available to all users in the organization

## Best Practices

Now that we have completed a review of the key concepts related to Azure Artifacts and walked through the capabilities in the Azure DevOps tool now is a good time to review the best practices related to Azure Artifacts. Make sure to review the best practices with the customer documented here https://docs.microsoft.com/en-us/azure/devops/artifacts/concepts/best-practices?view=azure-devops


